From 07a8402da0fa21b52633abed0c9a2362239cccf2 Mon Sep 17 00:00:00 2001
From: Sam Ravnborg <srn@skov.dk>
Date: Fri, 30 Dec 2016 13:22:16 +0100
Subject: [PATCH] boot fix - from sdk-arm

---
 board/skov/skov_cpu_module/skov_cpu_module.c |  2 +-
 include/configs/skov_cpu_module.h            | 67 +++++++++++++++++-----------
 2 files changed, 41 insertions(+), 28 deletions(-)

diff --git a/board/skov/skov_cpu_module/skov_cpu_module.c b/board/skov/skov_cpu_module/skov_cpu_module.c
index 3251ca1..0ef4abf 100644
--- a/board/skov/skov_cpu_module/skov_cpu_module.c
+++ b/board/skov/skov_cpu_module/skov_cpu_module.c
@@ -562,7 +562,7 @@ int board_init(void)
 			skov_with_ds1374 = 1;	
 			timer_init();
 			//4096 for one secound
-			ds1374_wdt_settimeout(1048576); //->4 minuts
+			ds1374_wdt_settimeout(1228800); //->5 minuts
 			writel(AT91_WDT_WDDIS, &wd->mr); //Disable internal wdt
 			wd_init = 1;
 		} else {
diff --git a/include/configs/skov_cpu_module.h b/include/configs/skov_cpu_module.h
index e389c19..117563d 100644
--- a/include/configs/skov_cpu_module.h
+++ b/include/configs/skov_cpu_module.h
@@ -98,6 +98,7 @@
 #define CONFIG_BOOTP_BOOTPATH		1
 #define CONFIG_BOOTP_GATEWAY		1
 #define CONFIG_BOOTP_HOSTNAME		1
+#define CONFIG_BOOTP_MAY_FAIL		1
 
 /*
  * Command line configuration.
@@ -174,10 +175,10 @@
 #define CONFIG_ENV_IS_IN_DATAFLASH
 
 #define CONFIG_ENV_IS_IN_FLASH
-#define CONFIG_ENV_SIZE                         0x000004200
+#define CONFIG_ENV_SIZE                         (16 * 1024)
 #define CONFIG_ENV_ADDR                         (CONFIG_SYS_DATAFLASH_LOGIC_ADDR_CS0 + 0x0007FE00)
 /* Address and size of Primary Environment Sector */
-#define CONFIG_ENV_SIZE_FLASH			0x000004200 /**< Must be smaller that 64KB otherwise h_export fails*/
+#define CONFIG_ENV_SIZE_FLASH			0x000004000 /**< Must be smaller that 64KB otherwise h_export fails*/
 #define CONFIG_ENV_ADDR_FLASH                   (CONFIG_SYS_FLASH_BASE + 0x00080000)
 #define CONFIG_ENV_SECT_SIZE_FLASH		0x00020000 /**< One sector is 128KB in Nor flash*/
 #define CONFIG_ENV_OVERWRITE			1 /**< San Rose It Shall be possible to change eth addr */
@@ -187,34 +188,46 @@
 #define xstr(s)   str(s)
 #define str(s)	#s
 
+/*
+KJP: layout_nor added 13 spaces to compensate for binary replacement by old layoutstring: physmap-flash.0:384k(u-boot),128k(Env),2048k(Linux),768k(Bmp_Image),-(User)
+*/
 #define CONFIG_BOOTCOUNT_LIMIT  		1 /**< San Rose do something else if it is not possible to boot default partiton */ 
 #define CONFIG_EXTRA_ENV_SETTINGS	\
 	"monitor_base=" xstr(CONFIG_SYS_MONITOR_BASE) "\0" \
-	"update=" \
-        "p0active=true\0" \
-        "altbootcmd=run bootcmd\0" \
-	"bootargs_common=console=ttyS0,115200 init=/bin/init.skov\0" \
-	"bootdelay=1\0" \
-        "bootlimit=3\0" \
-	"layout_nor=physmap-flash.0:512k(u-boot),128k(Env),2688k(Linux),-(Rootfs1)\0" \
-        "boot_flash=run flash_env_nor; run flash_exec\0" \
-        "flash_env_nor=echo \"NOR BOOT\"; set rootfs Rootfs1; run flash_bootargs_nor; set mtdids nor0=physmap-flash.0; set mtdparts mtdparts=$layout_nor\0" \
-        "flash_bootargs_nor=set bootargs $bootargs_common mtdparts=$layout_nor rw ubi.mtd=3 root=ubi0:Rootfs1 rootfstype=ubifs boot_flash mem_nor quiet\0" \
-	"flash_exec=bootm 100A0000\0" \
-	"flash_test=set bootcmd \"run boot_usb\"; save; run boot_flash;21000000\0" \
-	"boot_net=echo \"TFTP/NFS BOOT (NOR)\"; run net_bootargs_nor; run net_exec\0" \
-	"net_bootargs_nor=set bootargs \"$bootargs_common mtdparts=$layout_nor root=/dev/nfs rw nfsroot=$serverip ip=$ipaddr:$serverip:$gatewayip:$netmask boot_net mem_nor\"\0" \
-	"net_exec=tftp 21000000 SKOV/armkernel; bootm 21000000\0" \
-	"boot_usb=echo \"USB BOOT (NOR)\"; run usb_bootargs_nor; run usb_exec\0"\
-        "usb_bootargs_nor=set bootargs \"$bootargs_common mtdparts=$layout_nor root=/dev/ram0 rw ramdisk_size=30720 boot_usb mem_nor\"\0" \
-        "usb_exec=usb start; fatload usb 0:1 21000000 packk; fatload usb 0:1 21800000 packd; bootm 0x21000000 0x21800000\0" \
-        "ethaddr=MM:MM:MM:MM:MM:MM\0" \
-        "ipaddr=iii.iii.iii.iii\0" \
-        "netmask=mmm.mmm.mmm.mmm\0" \
-        "gatewayip=ggg.ggg.ggg.ggg\0" \
-        "serverip=sss.sss.sss.sss\0" \
-        "bootcmd=run boot_flash\0" \
-        "ipscheme=DHCP"
+    "rescue=Y\0" \
+    "ethaddr=MM:MM:MM:MM:MM:MM\0" \
+    "ipaddr=iii.iii.iii.iii\0" \
+    "netmask=mmm.mmm.mmm.mmm\0" \
+    "gatewayip=ggg.ggg.ggg.ggg\0" \
+    "serverip=sss.sss.sss.sss\0" \
+    "bootfile=BBBBBBBBBBBBBBBBBBBBBBBBB\0" \
+    "boot_xxxxx=if test \"${rescue}x\" = \"Yx\"; then echo \"RESCUE BOOT\"; run flash_env; setenv sdk_cmd \"19FaR\"; run flash_bootargs; run flash_exec; else run boot_xxxxx; fi\0" \
+    "bootcmd=run boot_xxxxx\0" \
+    "altbootcmd=run bootcmd\0" \
+    "bootargs_common=console=ttyS0,115200 init=/bin/init.skov\0" \
+    "bootlimit=3\0" \
+    "layout=\"physmap-flash.0:512k(u-boot),128k(Env),2688k(Linux),-(Rootfs1)\"\0" \
+    "boot_flash=run flash_env; run flash_bootargs; run flash_exec\0" \
+    "flash_env=echo \"NOR BOOT\"; setenv sdk_cmd \"19Fa\"; set rootfs Rootfs1; run flash_bootargs; set mtdids nor0=physmap-flash.0; set mtdparts mtdparts=$layout\0" \
+    "flash_bootargs=set bootargs $bootargs_common quiet mtdparts=$layout rw ubi.mtd=3 root=ubi0:Rootfs1 rootfstype=ubifs sdk_cmd=${sdk_cmd}\0" \
+    "flash_exec=bootm 100A0000\0" \
+    "flash_test=set bootcmd \"run boot_usb\"; save; run boot_flash;\0" \
+    "boot_net=run setrootpath; setenv sdk_cmd \"19Td\"; setenv filesize 0; tftp SKOV/arm_kernel; if test $filesize -eq 0; then tftp SKOV/arm_kernel; fi; echo \"TFTP/NFS BOOT\"; run net_bootargs; bootm $loadaddr\0" \
+    "boot_dhcp=setenv sdk_cmd \"19Td\"; run setrootpath; dhcp; echo \"TFTP/NFS BOOT\"; run net_bootargs; bootm $loadaddr\0" \
+    "net_bootargs=set bootargs \"$bootargs_common mtdparts=$layout root=/dev/nfs rw nfsroot=$rootpath,nfsvers=3 ip=$ipaddr:$serverip:$gatewayip:$netmask sdk_cmd=${sdk_cmd}\"\0" \
+    "net_exec=tftp 21000000 SKOV/arm_kernel; bootm 21000000\0" \
+    "setrootpath=setenv rootpath \"/tftpboot/$ipaddr\"\0" \
+    "boot_usb=echo \"USB BOOT\"; setenv sdk_cmd \"19Uc\"; run usb_bootargs; run usb_exec\0" \
+    "usb_bootargs=set bootargs \"$bootargs_common mtdparts=$layout root=/dev/ram0 rw ramdisk_size=30720 sdk_cmd=${sdk_cmd}\"\0" \
+    "usb_exec=usb start; fatload usb 0:1 21000000 packk; fatload usb 0:1 21800000 packd; bootm 0x21000000 0x21800000\0" \
+    "exec_flash=run boot_flash\0" \
+    "exec_usb=run boot_usb\0" \
+    "lcd_width=160\0" \
+    "lcd_height=160\0" \
+    "lcd_contrast=60\0" \
+    "lcd_size=160 160\0" \
+    "lcdtype=matrix\0" \
+    "lcd_bglight=80\0"
 /* NAND flash */
 #ifdef CONFIG_CMD_NAND
 #define CONFIG_CMD_UBI
-- 
1.8.3.1

