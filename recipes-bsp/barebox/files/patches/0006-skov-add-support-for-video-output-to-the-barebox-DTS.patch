From: Jan Luebbe <jlu@pengutronix.de>
Date: Tue, 6 Dec 2016 17:23:30 +0100
Subject: [PATCH] skov: add support for video output to the barebox DTS

Signed-off-by: Jan Luebbe <jlu@pengutronix.de>
---
 arch/arm/boards/skov-imx6/board.c   |  10 +++
 arch/arm/boards/skov-imx6/version.c |  23 ++++---
 arch/arm/dts/imx6qdl-skov-imx6.dtsi | 134 ++++++++++++++++++++++++++++++++++++
 3 files changed, 156 insertions(+), 11 deletions(-)

diff --git a/arch/arm/boards/skov-imx6/board.c b/arch/arm/boards/skov-imx6/board.c
index 0362379bb88a..8bb2c525e42b 100644
--- a/arch/arm/boards/skov-imx6/board.c
+++ b/arch/arm/boards/skov-imx6/board.c
@@ -16,6 +16,7 @@
 #include <common.h>
 #include <init.h>
 #include <mach/bbu.h>
+#include <environment.h>
 
 static int skov_imx6_devices_init(void)
 {
@@ -28,3 +29,12 @@ static int skov_imx6_devices_init(void)
 	return 0;
 }
 coredevice_initcall(skov_imx6_devices_init);
+
+static void skov_imx6_devices_shutdown(void)
+{
+	if (!of_machine_is_compatible("skov,imx6"))
+		return;
+
+	setenv("backlight0.brightness", "0");
+}
+predevshutdown_exitcall(skov_imx6_devices_shutdown);
diff --git a/arch/arm/boards/skov-imx6/version.c b/arch/arm/boards/skov-imx6/version.c
index 7f6651011d7c..c939994ddc19 100644
--- a/arch/arm/boards/skov-imx6/version.c
+++ b/arch/arm/boards/skov-imx6/version.c
@@ -20,6 +20,7 @@ struct board_description {
 	const char *revision;
 	const char *soc;
 	const char *dts_compatible;
+	const char *display;
 };
 
 static const struct board_description imx6_variants[] = {
@@ -83,60 +84,70 @@ static const struct board_description imx6_variants[] = {
 		.revision = "C",
 		.soc = "i.MX6S",
 		.dts_compatible = "skov,imx6dl-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[14] = {
 		.value = "high performance",
 		.revision = "C",
 		.soc = "i.MX6Q",
 		.dts_compatible = "skov,imx6q-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[15] = {
 		.value = "middle performance",
 		.revision = "C",
 		.soc = "i.MX6S",
 		.dts_compatible = "skov,imx6dl-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[16] = {
 		.value = "Solo_R512M_F4G",
 		.revision = "C",
 		.soc = "i.MX6S",
 		.dts_compatible = "skov,imx6dl-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[17] = {
 		.value = "Quad_R2G_F8G",
 		.revision = "C",
 		.soc = "i.MX6Q",
 		.dts_compatible = "skov,imx6q-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[18] = {
 		.value = "QuadPlus_R4G_F16G",
 		.revision = "C",
 		.soc = "i.MX6Q+",
 		.dts_compatible = "skov,imx6q-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[19] = {
 		.value = "Solo_R512M_F2G",
 		.revision = "C",
 		.soc = "i.MX6S",
 		.dts_compatible = "skov,imx6dl-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[20] = {
 		.value = "Quad_R1G_F4G",
 		.revision = "C",
 		.soc = "i.MX6Q",
 		.dts_compatible = "skov,imx6q-skov-revc-lt2",
+		.display = "l2rt",
 	},
 	[21] = {
 		.value = "Solo_R512M_F2G",
 		.revision = "C",
 		.soc = "i.MX6S",
 		.dts_compatible = "skov,imx6dl-skov-revc-lt6",
+		.display = "l6whrt",
 	},
 	[22] = {
 		.value = "Quad_R1G_F4G",
 		.revision = "C",
 		.soc = "i.MX6Q",
 		.dts_compatible = "skov,imx6q-skov-revc-lt6",
+		.display = "l6whrt",
 	},
 };
 
@@ -160,17 +171,6 @@ static void tweak_board(unsigned var)
 		break;
 	}
 
-	/* backlight handling */
-	switch (var) {
-	case 0 ... 8:
-		break;
-	default:
-		gpio_request(183, "backlight switch");
-		gpio_direction_output(183, 1); /* switch it off as early as possible */
-		gpio_request(1, "backlight brightness");
-		gpio_direction_output(1, 0); /* dark */
-	}
-
 	/* SD card handling */
 	gpio_request(205, "mmc io supply");
 	gpio_direction_output(205, 0); /* select 3.3 V IO voltage */
@@ -226,6 +226,7 @@ static int skov_version_probe(struct device_d *dev)
 	globalvar_add_simple("board.revision", imx6_variants[var].revision == NULL ? "undefined" : imx6_variants[var].revision);
 	globalvar_add_simple("board.soc", imx6_variants[var].soc == NULL ? "undefined" : imx6_variants[var].soc);
 	globalvar_add_simple("board.dts", imx6_variants[var].dts_compatible == NULL ? "undefined" : imx6_variants[var].dts_compatible);
+	globalvar_add_simple("board.display", imx6_variants[var].display == NULL ? "" : imx6_variants[var].display);
 
 	tweak_board(var);
 
diff --git a/arch/arm/dts/imx6qdl-skov-imx6.dtsi b/arch/arm/dts/imx6qdl-skov-imx6.dtsi
index 54651c894ad5..57e66eeb3b93 100644
--- a/arch/arm/dts/imx6qdl-skov-imx6.dtsi
+++ b/arch/arm/dts/imx6qdl-skov-imx6.dtsi
@@ -9,6 +9,8 @@
  * http://www.gnu.org/copyleft/gpl.html
  */
 
+#include <dt-bindings/gpio/gpio.h>
+
 / {
 	barebox_environment {
 		compatible = "barebox,environment";
@@ -127,6 +129,87 @@
 			};
 		};
 	};
+
+	backlight_lcd: backlight_lcd {
+		compatible = "pwm-backlight";
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_backlight>;
+		pwms = <&pwm2 0 20000>;
+		brightness-levels = <0 16 32 48 64 80 96 112 128 144 160 176 192 208 224 240 255>;
+		default-brightness-level = <8>;
+		enable-gpios = <&gpio6 23 GPIO_ACTIVE_LOW>;
+		status = "okay";
+	};
+
+	display@di0 {
+		status = "okay";
+		compatible = "fsl,imx-parallel-display";
+		pinctrl-names = "default";
+		pinctrl-0 = <&pinctrl_ipu1_4>;
+		interface-pix-fmt = "rgb24";
+
+		port {
+			display0_in: endpoint {
+				remote-endpoint = <&ipu1_di0_disp0>;
+			};
+		};
+
+		display-timings {
+			native-mode = &l2rt;
+
+			l2rt: l2rt {
+				native-mode;
+				clock-frequency = <33000000>;
+				hactive = <800>;
+				vactive = <480>;
+				hback-porch = <85>;
+				hfront-porch = <112>;
+				vback-porch = <29>;
+				vfront-porch = <38>;
+				hsync-len = <3>;
+				vsync-len = <3>;
+				pixelclk-active = <1>;
+				hsync-active = <0>;
+				vsync-active = <0>;
+				de-active = <1>;
+			};
+
+			l6whrt: l6whrt {
+				native-mode;
+				clock-frequency = <33000000>;
+				hactive = <800>;
+				vactive = <480>;
+				hback-porch = <43>;
+				hfront-porch = <154>;
+				vback-porch = <20>;
+				vfront-porch = <47>;
+				hsync-len = <3>;
+				vsync-len = <3>;
+				pixelclk-active = <1>;
+				hsync-active = <0>;
+				vsync-active = <0>;
+				de-active = <1>;
+			};
+		};
+	};
+};
+
+&pwm2 {
+	/* used for backlight brightness */
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_pwm2_2>;
+	status = "okay";
+};
+
+&pwm3 {
+	/* used for LCD contrast control */
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_pwm3_2>;
+	status = "okay";
+};
+
+&ipu1_di0_disp0 {
+	remote-endpoint = <&display0_in>;
 };
 
 &iomuxc {
@@ -225,6 +308,57 @@
 			MX6QDL_PAD_NANDF_D7__NAND_DATA07 0xb0b1
 		>;
 	};
+
+	pinctrl_ipu1_4: ipu1grp-4 {
+		fsl,pins = <
+			MX6QDL_PAD_DI0_DISP_CLK__IPU1_DI0_DISP_CLK	0x10
+			MX6QDL_PAD_DI0_PIN15__IPU1_DI0_PIN15		0x10
+			MX6QDL_PAD_DI0_PIN2__IPU1_DI0_PIN02		0x10
+			MX6QDL_PAD_DI0_PIN3__IPU1_DI0_PIN03		0x10
+			MX6QDL_PAD_DISP0_DAT0__IPU1_DISP0_DATA00	0x10
+			MX6QDL_PAD_DISP0_DAT1__IPU1_DISP0_DATA01	0x10
+			MX6QDL_PAD_DISP0_DAT2__IPU1_DISP0_DATA02	0x10
+			MX6QDL_PAD_DISP0_DAT3__IPU1_DISP0_DATA03	0x10
+			MX6QDL_PAD_DISP0_DAT4__IPU1_DISP0_DATA04	0x10
+			MX6QDL_PAD_DISP0_DAT5__IPU1_DISP0_DATA05	0x10
+			MX6QDL_PAD_DISP0_DAT6__IPU1_DISP0_DATA06	0x10
+			MX6QDL_PAD_DISP0_DAT7__IPU1_DISP0_DATA07	0x10
+			MX6QDL_PAD_DISP0_DAT8__IPU1_DISP0_DATA08	0x10
+			MX6QDL_PAD_DISP0_DAT9__IPU1_DISP0_DATA09	0x10
+			MX6QDL_PAD_DISP0_DAT10__IPU1_DISP0_DATA10	0x10
+			MX6QDL_PAD_DISP0_DAT11__IPU1_DISP0_DATA11	0x10
+			MX6QDL_PAD_DISP0_DAT12__IPU1_DISP0_DATA12	0x10
+			MX6QDL_PAD_DISP0_DAT13__IPU1_DISP0_DATA13	0x10
+			MX6QDL_PAD_DISP0_DAT14__IPU1_DISP0_DATA14	0x10
+			MX6QDL_PAD_DISP0_DAT15__IPU1_DISP0_DATA15	0x10
+			MX6QDL_PAD_DISP0_DAT16__IPU1_DISP0_DATA16	0x10
+			MX6QDL_PAD_DISP0_DAT17__IPU1_DISP0_DATA17	0x10
+			MX6QDL_PAD_DISP0_DAT18__IPU1_DISP0_DATA18	0x10
+			MX6QDL_PAD_DISP0_DAT19__IPU1_DISP0_DATA19	0x10
+			MX6QDL_PAD_DISP0_DAT20__IPU1_DISP0_DATA20	0x10
+			MX6QDL_PAD_DISP0_DAT21__IPU1_DISP0_DATA21	0x10
+			MX6QDL_PAD_DISP0_DAT22__IPU1_DISP0_DATA22	0x10
+			MX6QDL_PAD_DISP0_DAT23__IPU1_DISP0_DATA23	0x10
+		>;
+	};
+
+	pinctrl_backlight: backlight_grp {
+		fsl,pins = <
+			MX6QDL_PAD_RGMII_TD3__GPIO6_IO23	0x40000058
+		>;
+	};
+
+	pinctrl_pwm2_2: pwm2grp-2 {
+		fsl,pins = <
+			MX6QDL_PAD_GPIO_1__PWM2_OUT		0x00058
+		>;
+	};
+
+	pinctrl_pwm3_2: pwm3grp-2 {
+		fsl,pins = <
+			MX6QDL_PAD_SD1_DAT1__PWM3_OUT		0x00058
+		>;
+	};
 };
 
 /* console */
