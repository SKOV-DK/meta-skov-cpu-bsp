From: =?UTF-8?q?Ulrich=20=C3=96lmann?= <u.oelmann@pengutronix.de>
Date: Tue, 21 Mar 2017 10:42:59 +0100
Subject: [PATCH] skov: choose environment depending on bootsource
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Use the third DOS partition on the SD-card for the environment when booted from
SD-card and otherwise the former partition on the SPI NOR flash.

Signed-off-by: Ulrich Ã–lmann <u.oelmann@pengutronix.de>
---
 arch/arm/boards/skov-imx6/board.c   | 41 +++++++++++++++++++++++++++++++------
 arch/arm/dts/imx6qdl-skov-imx6.dtsi | 15 +++++++++++---
 2 files changed, 47 insertions(+), 9 deletions(-)

diff --git a/arch/arm/boards/skov-imx6/board.c b/arch/arm/boards/skov-imx6/board.c
index 9625390b1ffa..29c0b4385802 100644
--- a/arch/arm/boards/skov-imx6/board.c
+++ b/arch/arm/boards/skov-imx6/board.c
@@ -18,6 +18,7 @@
 #include <mach/bbu.h>
 #include <environment.h>
 #include <i2c/i2c.h>
+#include <bootsource.h>
 
 static int skov_imx6_fixup(struct device_node *root, void *unused)
 {
@@ -26,13 +27,21 @@ static int skov_imx6_fixup(struct device_node *root, void *unused)
 	uint32_t brightness;
 	struct device_node *node;
 
-	val = getenv("state.display.brightness");
-	if (!val) {
-		pr_err("could not get default display brightness\n");
-		return 0;
-	}
+	switch (bootsource_get()) {
+	case BOOTSOURCE_MMC:
+		/* use default value of state variable defined in devicetree */
+		brightness = 8;
+		break;
+	default:
+		val = getenv("state.display.brightness");
+		if (!val) {
+			pr_err("could not get default display brightness\n");
+			return 0;
+		}
 
-	brightness = simple_strtoul(val, NULL, 0);
+		brightness = simple_strtoul(val, NULL, 0);
+		break;
+	}
 
 	for_each_compatible_node_from(node, root, NULL, "pwm-backlight") {
 		ret = of_property_write_u32(node, "default-brightness-level", brightness);
@@ -46,6 +55,9 @@ static int skov_imx6_fixup(struct device_node *root, void *unused)
 
 static int skov_imx6_devices_init(void)
 {
+	char *environment_path, *envdev;
+	int ret;
+
 	if (!of_machine_is_compatible("skov,imx6"))
 		return 0;
 
@@ -54,6 +66,23 @@ static int skov_imx6_devices_init(void)
 
 	of_register_fixup(skov_imx6_fixup, NULL);
 
+	switch (bootsource_get()) {
+	case BOOTSOURCE_MMC:
+		environment_path = "/chosen/environment-sd";
+		envdev = "MMC";
+		break;
+	default:
+		environment_path = "/chosen/environment-spinor";
+		envdev = "SPI NOR flash";
+		break;
+	}
+	pr_notice("Using environment in %s\n", envdev);
+
+	ret = of_device_enable_path(environment_path);
+	if (ret < 0)
+		pr_warn("Failed to enable environment partition '%s' (%d)\n",
+			environment_path, ret);
+
 	return 0;
 }
 coredevice_initcall(skov_imx6_devices_init);
diff --git a/arch/arm/dts/imx6qdl-skov-imx6.dtsi b/arch/arm/dts/imx6qdl-skov-imx6.dtsi
index 3de79248d516..ae712a0b87f3 100644
--- a/arch/arm/dts/imx6qdl-skov-imx6.dtsi
+++ b/arch/arm/dts/imx6qdl-skov-imx6.dtsi
@@ -16,9 +16,18 @@
 		state = &state;
 	};
 
-	barebox_environment {
-		compatible = "barebox,environment";
-		device-path = &barebox_env;
+	chosen {
+		environment-sd {
+			compatible = "barebox,environment";
+			device-path = &usdhc3, "partname:2";
+			status = "disabled";
+		};
+
+		environment-spinor {
+			compatible = "barebox,environment";
+			device-path = &barebox_env;
+			status = "disabled";
+		};
 	};
 
 	leds {
