From: Rouven Czerwinski <r.czerwinski@pengutronix.de>
Date: Fri, 3 Dec 2021 15:01:10 +0100
Subject: [PATCH] ARM: dts: i.MX8MP: add state and a temporary backend for the
 i.MX8MP-EVK
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Barebox currently lacks a mechanism to automatically detect a state partition
based upon its GPT partition-type-uuid. Until then one has to explicitly define
the partition layout in the devicetree, as well, to be able to refer to the
state's (and the environment's) backend via a phandle. The devicetree's
information needs to stay in sync with the GPTs' contents to have barebox' state
subsystem and Linux userspace's barebox-state utility refer to the same location
on the eMMC. The same is true with regard to barebox' environment. Remove the
unneeded barebox partition from the eMMC, since barebox lives in its boot
partitions. Donate a "dt-" prefix to the partitions' labels to avoid collisions
with names of partitions defined in the GPT and switch from the legacy partition
binding to the current fixed-partition scheme.

Signed-off-by: Rouven Czerwinski <r.czerwinski@pengutronix.de>
Signed-off-by: Ulrich Ã–lmann <u.oelmann@pengutronix.de>
---
 arch/arm/dts/imx8mp-evk.dts | 116 ++++++++++++++++++++++++++++++++++++--------
 1 file changed, 96 insertions(+), 20 deletions(-)

diff --git a/arch/arm/dts/imx8mp-evk.dts b/arch/arm/dts/imx8mp-evk.dts
index d992b14882a3..3a54b7e87e50 100644
--- a/arch/arm/dts/imx8mp-evk.dts
+++ b/arch/arm/dts/imx8mp-evk.dts
@@ -10,15 +10,19 @@
 #include "imx8mp.dtsi"
 
 / {
+	aliases {
+		state = &state;
+	};
+
 	chosen {
 		environment-sd {
 			compatible = "barebox,environment";
-			device-path = &env_sd2;
+			device-path = &env_sd;
 			status = "disabled";
 		};
 		environment-emmc {
 			compatible = "barebox,environment";
-			device-path = &env_sd3;
+			device-path = &env_emmc;
 			status = "disabled";
 		};
 	};
@@ -28,6 +32,70 @@
 			barebox,default-trigger = "heartbeat";
 		};
 	};
+
+	state: state {
+		#address-cells = <1>;
+		#size-cells = <1>;
+		compatible = "barebox,state";
+		magic = <0x1c5b3f49>;
+		backend-type = "raw";
+		backend = <&state_emmc>;
+		/*
+		 * barebox-state partition size: 1 MiB
+		 * nr. of redundant copies:      4
+		 * ==> max. stride size: 1 MiB / 4 = 256 KiB = 262144 Byte
+		 *
+		 * stride size:     262144 Byte
+		 * raw-header:     -    16 Byte
+		 * direct-storage: -     8 Byte
+		 *                 ------------
+		 * max state size:  262120 Byte
+		 *                  ===========
+		 */
+		backend-stridesize = <0x40000>;
+
+		bootstate {
+			#address-cells = <1>;
+			#size-cells = <1>;
+
+			system0 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+
+				remaining_attempts@0 {
+					reg = <0x0 0x4>;
+					type = "uint32";
+					default = <3>;
+				};
+				priority@4 {
+					reg = <0x4 0x4>;
+					type = "uint32";
+					default = <30>;
+				};
+			};
+
+			system1 {
+				#address-cells = <1>;
+				#size-cells = <1>;
+
+				remaining_attempts@8 {
+					reg = <0x8 0x4>;
+					type = "uint32";
+					default = <3>;
+				};
+				priority@C {
+					reg = <0xC 0x4>;
+					type = "uint32";
+					default = <20>;
+				};
+			};
+
+			last_chosen@10 {
+				reg = <0x10 0x4>;
+				type = "uint32";
+			};
+		};
+	};
 };
 
 &ethphy1 {
@@ -40,32 +108,40 @@
 };
 
 &usdhc2 {
-	#address-cells = <1>;
-	#size-cells = <1>;
+	/* Remember to keep this synchronized with the SD-card images' GPT! */
+	partitions {
+		compatible = "fixed-partitions";
+		#address-cells = <1>;
+		#size-cells = <1>;
 
-	partition@0 {
-		label = "barebox";
-		reg = <0x0 0xe0000>;
-	};
+		partition@0 {
+			label = "barebox";
+			reg = <0x0 0x100000>;
+		};
 
-	env_sd2: partition@e0000 {
-		label = "barebox-environment";
-		reg = <0xe0000 0x20000>;
+		env_sd: partition@100000 {
+			label = "dt-barebox-environment";
+			reg = <0x100000 0x100000>;
+		};
 	};
 };
 
 &usdhc3 {
-	#address-cells = <1>;
-	#size-cells = <1>;
+	/* Remember to keep this synchronized with the eMMC images' GPT! */
+	partitions {
+		compatible = "fixed-partitions";
+		#address-cells = <1>;
+		#size-cells = <1>;
 
-	partition@0 {
-		label = "barebox";
-		reg = <0x0 0xe0000>;
-	};
+		env_emmc: partition@100000 {
+			label = "dt-barebox-environment";
+			reg = <0x100000 0x100000>;
+		};
 
-	env_sd3: partition@e0000 {
-		label = "barebox-environment";
-		reg = <0xe0000 0x20000>;
+		state_emmc: partition@200000 {
+			label = "dt-barebox-state";
+			reg = <0x200000 0x100000>;
+		};
 	};
 };
 
