From: =?UTF-8?q?Ulrich=20=C3=96lmann?= <u.oelmann@pengutronix.de>
Date: Thu, 19 Dec 2019 15:13:43 +0100
Subject: [PATCH] Revert "imd: fix memory leak"
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

To be able to apply commit [1] which is essential to cope with low memory
situations when the userspace utility bareboximd is utilized one has to revert
barebox' commit [2]. The latter on the other hand fixes a memory leak in
barebox' internal command "imd" which is not used during regular operation, so
that reverting it does not hurt.

[1] 8e4ca0dfce43 ("bareboximd: workaround for page allocation fault")
[2] 09fd5267dfb9 ("imd: fix memory leak")

Signed-off-by: Ulrich Ã–lmann <u.oelmann@pengutronix.de>
---
 common/imd.c | 20 ++++++--------------
 1 file changed, 6 insertions(+), 14 deletions(-)

diff --git a/common/imd.c b/common/imd.c
index 913a01de87bf..05e118e77361 100644
--- a/common/imd.c
+++ b/common/imd.c
@@ -337,10 +337,8 @@ int imd_command(int argc, char *argv[])
 		return -errno;
 
 	imd_start = imd_get(buf, size);
-	if (IS_ERR(imd_start)) {
-		ret = PTR_ERR(imd_start);
-		goto out;
-	}
+	if (IS_ERR(imd_start))
+		return PTR_ERR(imd_start);
 
 	if (type == IMD_TYPE_INVALID) {
 		imd_for_each(imd_start, imd) {
@@ -358,8 +356,7 @@ int imd_command(int argc, char *argv[])
 		imd = imd_find_type(imd_start, type);
 		if (!imd) {
 			debug("No tag of type 0x%08x found\n", type);
-			ret = -ENODATA;
-			goto out;
+			return -ENODATA;
 		}
 
 		if (imd_is_string(type)) {
@@ -373,10 +370,8 @@ int imd_command(int argc, char *argv[])
 				str = imd_concat_strings(imd);
 			}
 
-			if (!str) {
-				ret = -ENODATA;
-				goto out;
-			}
+			if (!str)
+				return -ENODATA;
 
 			if (variable_name)
 				imd_command_setenv(variable_name, str);
@@ -389,8 +384,5 @@ int imd_command(int argc, char *argv[])
 		}
 	}
 
-	ret = 0;
-out:
-	free(buf);
-	return ret;
+	return 0;
 }
