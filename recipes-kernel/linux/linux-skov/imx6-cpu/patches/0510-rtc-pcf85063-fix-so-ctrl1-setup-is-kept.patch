From 310bc95bed06c992e275f0d4246bd4fa4dd8857b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?S=C3=B8ren=20Andersen?= <san@skov.dk>
Date: Wed, 9 May 2018 11:19:29 +0200
Subject: [PATCH 1/1] rtc: pcf85063: fix so ctrl1 setup is kept
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fix that content of ctrl1 is not overwritten in pcf85063_stop_clock
Previously the content of the register was lost when using
the return result of i2s_smbus_write_byte

This had the side effect that the setup of cap_sel was lost.
Which again resulted in a situation where we could not read the
clock because the OS bit indicated that oscillator was not stable.

Signed-off-by: SÃ¸ren Andersen <san@skov.dk>
---
 drivers/rtc/rtc-pcf85063.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/drivers/rtc/rtc-pcf85063.c b/drivers/rtc/rtc-pcf85063.c
index 30e447c..5330e87 100644
--- a/drivers/rtc/rtc-pcf85063.c
+++ b/drivers/rtc/rtc-pcf85063.c
@@ -46,6 +46,7 @@
 
 static int pcf85063_stop_clock(struct i2c_client *client, u8 *ctrl1)
 {
+	u8 reg_ctrl;
 	s32 ret;
 
 	ret = i2c_smbus_read_byte_data(client, PCF85063_REG_CTRL1);
@@ -55,15 +56,15 @@ static int pcf85063_stop_clock(struct i2c_client *client, u8 *ctrl1)
 	}
 
 	/* stop the clock */
-	ret |= PCF85063_REG_CTRL1_STOP;
+	reg_ctrl = ret | PCF85063_REG_CTRL1_STOP;
 
-	ret = i2c_smbus_write_byte_data(client, PCF85063_REG_CTRL1, ret);
+	ret = i2c_smbus_write_byte_data(client, PCF85063_REG_CTRL1, reg_ctrl);
 	if (ret < 0) {
 		dev_err(&client->dev, "Failing to stop the clock\n");
 		return -EIO;
 	}
 
-	*ctrl1 = ret;
+	*ctrl1 = reg_ctrl;
 
 	return 0;
 }
-- 
1.8.3.1

