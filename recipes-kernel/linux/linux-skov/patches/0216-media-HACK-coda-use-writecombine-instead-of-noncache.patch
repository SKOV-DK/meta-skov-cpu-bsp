From: Philipp Zabel <p.zabel@pengutronix.de>
Date: Thu, 31 Mar 2016 12:37:47 +0200
Subject: [PATCH] media: HACK: coda: use writecombine instead of
 noncached/coherent mappings

both in kernel and userspace.
This works around a problem that occurs with an optimized thumb2 memcpy
implementation in libc: unaligned ldr/str accesses to strongly ordered
and device memory mappings are not supported on ARMv6/ARMv7.

Signed-off-by: Philipp Zabel <p.zabel@pengutronix.de>
---
 drivers/media/platform/coda/coda-common.c | 3 +++
 drivers/media/platform/coda/coda.h        | 1 +
 2 files changed, 4 insertions(+)

diff --git a/drivers/media/platform/coda/coda-common.c b/drivers/media/platform/coda/coda-common.c
index 942ffc076784..4ca6952767c7 100644
--- a/drivers/media/platform/coda/coda-common.c
+++ b/drivers/media/platform/coda/coda-common.c
@@ -2566,6 +2566,7 @@ static int coda_queue_init(struct coda_ctx *ctx, struct vb2_queue *vq)
 	 */
 	vq->min_buffers_needed = 1;
 	vq->dev = ctx->dev->dev;
+	vq->dma_attrs = ctx->dma_attrs;
 
 	return vb2_queue_init(vq);
 }
@@ -2643,6 +2644,8 @@ static int coda_open(struct file *file)
 		goto err_coda_name_init;
 	}
 
+	ctx->dma_attrs = DMA_ATTR_WRITE_COMBINE;
+
 	ctx->debugfs_entry = debugfs_create_dir(name, dev->debugfs_root);
 	kfree(name);
 
diff --git a/drivers/media/platform/coda/coda.h b/drivers/media/platform/coda/coda.h
index 3645a2ebcf46..e43fb17988be 100644
--- a/drivers/media/platform/coda/coda.h
+++ b/drivers/media/platform/coda/coda.h
@@ -227,6 +227,7 @@ struct coda_ctx {
 	struct work_struct		seq_init_work;
 	struct work_struct		seq_end_work;
 	struct completion		completion;
+	unsigned long			dma_attrs;
 	const struct coda_video_device	*cvd;
 	const struct coda_context_ops	*ops;
 	int				aborting;
