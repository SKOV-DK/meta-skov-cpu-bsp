From: Oleksij Rempel <o.rempel@pengutronix.de>
Date: Mon, 2 Oct 2023 12:44:43 +0200
Subject: [PATCH] regulator: fixed: implement under-voltage irq

Add interrupt support for under-voltage notification

Signed-off-by: Oleksij Rempel <o.rempel@pengutronix.de>
---
 drivers/regulator/fixed.c | 40 ++++++++++++++++++++++++++++++++++++++++
 1 file changed, 40 insertions(+)

diff --git a/drivers/regulator/fixed.c b/drivers/regulator/fixed.c
index 55130efae9b8..e10c27c3ab80 100644
--- a/drivers/regulator/fixed.c
+++ b/drivers/regulator/fixed.c
@@ -105,6 +105,39 @@ static int reg_is_enabled(struct regulator_dev *rdev)
 	return priv->enable_counter > 0;
 }
 
+static irqreturn_t under_voltage_irq_handler(int irq, void *data)
+{
+	struct fixed_voltage_data *priv = data;
+	struct regulator_dev *rdev = priv->dev;
+	int ret;
+
+	ret = regulator_notifier_call_chain(rdev, REGULATOR_EVENT_UNDER_VOLTAGE_WARN,
+					    NULL);
+	if (ret == NOTIFY_BAD)
+		dev_err(rdev_get_dev(rdev),
+			"Failed to notify under voltage event\n");
+
+	return IRQ_HANDLED;
+}
+
+static int get_fixed_volatage_irqs(struct device *dev,
+				      struct fixed_voltage_data *priv)
+{
+	int ret;
+
+	ret = fwnode_irq_get_byname(dev_fwnode(dev), "under-voltage");
+	/* This is optional IRQ. Ignore if not found */
+	if (ret < 0)
+		return 0;
+
+	ret = devm_request_threaded_irq(dev, ret, NULL,
+					under_voltage_irq_handler,
+					IRQF_ONESHOT, "under-voltage", priv);
+	if (ret < 0)
+		return ret;
+
+	return 0;
+}
 
 /**
  * of_get_fixed_voltage_config - extract fixed_voltage_config structure info
@@ -294,6 +327,13 @@ static int reg_fixed_voltage_probe(struct platform_device *pdev)
 	dev_dbg(&pdev->dev, "%s supplying %duV\n", drvdata->desc.name,
 		drvdata->desc.fixed_uV);
 
+	ret = get_fixed_volatage_irqs(dev, drvdata);
+	if (ret) {
+		dev_err(&pdev->dev, "Failed to get IRQs: %pe. TODO: clean up things\n",
+			ERR_PTR(ret));
+		return ret;
+	}
+
 	return 0;
 }
 
