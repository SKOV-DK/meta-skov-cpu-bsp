From: Michael Grzeschik <m.grzeschik@pengutronix.de>
Date: Tue, 17 Dec 2019 13:43:22 +0100
Subject: [PATCH] net: dsa: microchip: add mutex locking to vlan handling

Signed-off-by: Michael Grzeschik <m.grzeschik@pengutronix.de>
---
 drivers/net/dsa/microchip/ksz8795.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/drivers/net/dsa/microchip/ksz8795.c b/drivers/net/dsa/microchip/ksz8795.c
index e39a41ee2476..48bc62dd5fa6 100644
--- a/drivers/net/dsa/microchip/ksz8795.c
+++ b/drivers/net/dsa/microchip/ksz8795.c
@@ -683,6 +683,8 @@ static void ksz8_r_vlan_table(struct ksz_device *dev, u16 vid, u32 *vlan)
 	u16 addr = vid / dev->phy_port_cnt;
 	u64 buf;
 
+	mutex_lock(&dev->vlan_mutex);
+
 	ksz8_r_table(dev, TABLE_VLAN, addr, &buf);
 	if (dev->features & IS_88X3) {
 		*vlan = (u32)buf;
@@ -691,6 +693,8 @@ static void ksz8_r_vlan_table(struct ksz_device *dev, u16 vid, u32 *vlan)
 
 		*vlan = data[vid & 3];
 	}
+
+	mutex_unlock(&dev->vlan_mutex);
 }
 
 static void ksz8_w_vlan_table(struct ksz_device *dev, u16 vid, u32 vlan)
@@ -698,6 +702,8 @@ static void ksz8_w_vlan_table(struct ksz_device *dev, u16 vid, u32 vlan)
 	u16 addr = vid / dev->phy_port_cnt;
 	u64 buf;
 
+	mutex_lock(&dev->vlan_mutex);
+
 	ksz8_r_table(dev, TABLE_VLAN, addr, &buf);
 
 	if (dev->features & IS_88X3) {
@@ -710,6 +716,8 @@ static void ksz8_w_vlan_table(struct ksz_device *dev, u16 vid, u32 vlan)
 
 	dev->vlan_cache[vid].table[0] = vlan;
 	ksz8_w_table(dev, TABLE_VLAN, addr, buf);
+
+	mutex_unlock(&dev->vlan_mutex);
 }
 
 static void ksz8_r_phy(struct ksz_device *dev, u16 phy, u16 reg, u16 *val)
