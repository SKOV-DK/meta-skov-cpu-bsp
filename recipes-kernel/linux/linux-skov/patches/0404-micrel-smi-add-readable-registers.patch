From: Michael Grzeschik <m.grzeschik@pengutronix.de>
Date: Thu, 14 Apr 2016 17:02:28 +0200
Subject: [PATCH] micrel-smi: add readable registers

Signed-off-by: Michael Grzeschik <m.grzeschik@pengutronix.de>
---
 drivers/net/phy/micrel-smi.c | 35 +++++++++++++++++++++++++++++++++++
 drivers/net/phy/micrel-smi.h | 14 ++++++++++++++
 2 files changed, 49 insertions(+)

diff --git a/drivers/net/phy/micrel-smi.c b/drivers/net/phy/micrel-smi.c
index 2b44e61e7e87..30287e920add 100644
--- a/drivers/net/phy/micrel-smi.c
+++ b/drivers/net/phy/micrel-smi.c
@@ -134,12 +134,47 @@ static bool micrel_ksz8873_writeable_reg(struct device *dev, unsigned int reg)
 	return false;
 }
 
+static bool micrel_ksz8873_readable_reg(struct device *dev, unsigned int reg)
+{
+
+	/* ro addresses */
+
+	switch (reg) {
+	case REG_SWITCH_ID:
+	case REG_SWITCH_CTRL_6:
+	case REG_SWITCH_CTRL_7:
+	case REG_SWITCH_CTRL_8:
+	case REG_LINKMD_RES:
+	case REG_PORT_1_STATUS1:
+	case (REG_PORT_1_STATUS1 + REG_PORT_CTRL_OFFSET):
+	case REG_SWITCH_MODE_STATUS:
+	case HIGH_PRIORITY_PACKET_BUFFER_Q1:
+	case HIGH_PRIORITY_PACKET_BUFFER_Q2:
+	case HIGH_PRIORITY_PACKET_BUFFER_Q3:
+	case HIGH_PRIORITY_PACKET_BUFFER_Q4:
+	case PM_USAGE_FLOW_CONTROL_MODE_1:
+	case PM_USAGE_FLOW_CONTROL_MODE_2:
+	case PM_USAGE_FLOW_CONTROL_MODE_3:
+	case PM_USAGE_FLOW_CONTROL_MODE_4:
+		return true;
+	default:
+		return false;
+	}
+}
+
+static bool micrel_ksz8873_volatile_reg(struct device *dev, unsigned int reg)
+{
+	return true;
+}
+
 static struct regmap_config micrel_ksz8873_regmap_config = {
 	.reg_bits = 16,
 	.val_bits = 8,
 	.reg_stride = 1,
 	.cache_type = REGCACHE_RBTREE,
 	.writeable_reg = micrel_ksz8873_writeable_reg,
+	.readable_reg = micrel_ksz8873_readable_reg,
+	.volatile_reg = micrel_ksz8873_volatile_reg,
 	.ranges = ksz8873_ranges,
 	.num_ranges = ARRAY_SIZE(ksz8873_ranges),
 	.name = "micrel-ksz8873",
diff --git a/drivers/net/phy/micrel-smi.h b/drivers/net/phy/micrel-smi.h
index 7d28c44c9f94..bda8d533a1f2 100644
--- a/drivers/net/phy/micrel-smi.h
+++ b/drivers/net/phy/micrel-smi.h
@@ -71,6 +71,10 @@
 #define REG_SWITCH_CTRL_5          0x07        /* Global Control 5 */
 #define   BROADCAST_STORM_RATE_LO    (0xFF)       /* Broadcast storm protection rate bit[7:0] mask */
 
+#define REG_SWITCH_CTRL_6          0x08        /* Global Control 6 */
+#define REG_SWITCH_CTRL_7          0x09        /* Global Control 7 */
+#define REG_SWITCH_CTRL_8          0x0a        /* Global Control 8 */
+
 #define REG_SWITCH_CTRL_9          0x0B        /* Global Control 9 */
 #define   SWITCH_CPU_CLK_31          (0x00)       /* CPU Port interface clock is 31.25Mhz */
 #define   SWITCH_CPU_CLK_62          (0x40)       /* CPU Port interface clock is 62.5Mhz */
@@ -212,6 +216,8 @@
 /* Port 3 Registers are Port 2 register + REG_PORT_CTRL_OFFSET */
 #define	  REG_PORT_CTRL_OFFSET       (0x10)
 
+#define   REG_LINKMD_RES           0x2b
+
 #define REG_RESET_CTRL             0x43        /* Reset */
 #define   GLOBAL_SOFTWARE_RESET      (1 << 4)     /* Global software reset */
 #define   PCS_RESET                  (1 << 0)     /* PCS reset */
@@ -302,6 +308,14 @@
 
 
 #define REG_SWITCH_MODE_STATUS     0xA6       /* KSZ8873 mode indicator  */
+#define HIGH_PRIORITY_PACKET_BUFFER_Q1 0xA7       /* High Priority packet buffer for Q3 */
+#define HIGH_PRIORITY_PACKET_BUFFER_Q2 0xA8       /* High Priority packet buffer for Q2 */
+#define HIGH_PRIORITY_PACKET_BUFFER_Q3 0xA9       /* High Priority packet buffer for Q1 */
+#define HIGH_PRIORITY_PACKET_BUFFER_Q4 0xAA       /* High Priority packet buffer for Q0 */
+#define PM_USAGE_FLOW_CONTROL_MODE_1 0xAB       /* PM Usage Flow Control Select Mode 1 */
+#define PM_USAGE_FLOW_CONTROL_MODE_2 0xAC       /* PM Usage Flow Control Select Mode 2 */
+#define PM_USAGE_FLOW_CONTROL_MODE_3 0xAD       /* PM Usage Flow Control Select Mode 3 */
+#define PM_USAGE_FLOW_CONTROL_MODE_4 0xAE       /* PM Usage Flow Control Select Mode 3 */
 
 /* interrupt register */
 
