From: Lucas Stach <l.stach@pengutronix.de>
Date: Thu, 15 Feb 2018 10:49:12 +0100
Subject: [PATCH] drm/etnaviv: init DMA ops for virtual master device

All the DRM GEM dma-buf import/export operations are done through the
virtual DRM master device. As this isn't instanciated from DT anymore
we need to make sure the DMA ops are set up correctly.

Signed-off-by: Lucas Stach <l.stach@pengutronix.de>
---
 drivers/gpu/drm/etnaviv/etnaviv_drv.c | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/etnaviv/etnaviv_drv.c b/drivers/gpu/drm/etnaviv/etnaviv_drv.c
index ab50090d066c..97fc081da9c5 100644
--- a/drivers/gpu/drm/etnaviv/etnaviv_drv.c
+++ b/drivers/gpu/drm/etnaviv/etnaviv_drv.c
@@ -655,8 +655,6 @@ static int etnaviv_pdev_probe(struct platform_device *pdev)
 	struct device *dev = &pdev->dev;
 	struct component_match *match = NULL;
 
-	dma_set_coherent_mask(&pdev->dev, DMA_BIT_MASK(32));
-
 	if (!dev->platform_data) {
 		struct device_node *core_node;
 
@@ -713,10 +711,19 @@ static int __init etnaviv_init(void)
 	 * the DRM platform device.
 	 */
 	for_each_compatible_node(np, NULL, "vivante,gc") {
+		struct platform_device *pdev;
+
 		if (!of_device_is_available(np))
 			continue;
 
-		platform_device_register_simple("etnaviv", -1, NULL, 0);
+		pdev = platform_device_register_simple("etnaviv", -1, NULL, 0);
+		/*
+		 * There might be a nicer way to configure the virtual master
+		 * device DMA ops than to use the configuration of the first
+		 * GPU device, but this is good enough for now.
+		 */
+		of_dma_configure(&pdev->dev, np);
+
 		of_node_put(np);
 		break;
 	}
