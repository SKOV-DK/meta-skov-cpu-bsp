From: Lucas Stach <l.stach@pengutronix.de>
Date: Thu, 22 Nov 2018 16:38:53 +0100
Subject: [PATCH] drm/etnaviv: avoid false sharing of fence spinlock

TODO: measure if this really reduces contention.

Signed-off-by: Lucas Stach <l.stach@pengutronix.de>
---
 drivers/gpu/drm/etnaviv/etnaviv_gpu.c | 5 +++--
 drivers/gpu/drm/etnaviv/etnaviv_gpu.h | 1 -
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/etnaviv/etnaviv_gpu.c b/drivers/gpu/drm/etnaviv/etnaviv_gpu.c
index 293e248e1b29..1f9cf438e35a 100644
--- a/drivers/gpu/drm/etnaviv/etnaviv_gpu.c
+++ b/drivers/gpu/drm/etnaviv/etnaviv_gpu.c
@@ -1006,6 +1006,7 @@ void etnaviv_gpu_recover_hang(struct etnaviv_gpu *gpu)
 /* fence object management */
 struct etnaviv_fence {
 	struct etnaviv_gpu *gpu;
+	struct spinlock lock;
 	struct dma_fence base;
 };
 
@@ -1062,8 +1063,9 @@ static struct dma_fence *etnaviv_gpu_fence_alloc(struct etnaviv_gpu *gpu)
 		return NULL;
 
 	f->gpu = gpu;
+	spin_lock_init(&f->lock);
 
-	dma_fence_init(&f->base, &etnaviv_fence_ops, &gpu->fence_spinlock,
+	dma_fence_init(&f->base, &etnaviv_fence_ops, &f->lock,
 		       gpu->fence_context, ++gpu->next_fence);
 
 	return &f->base;
@@ -1631,7 +1633,6 @@ static int etnaviv_gpu_bind(struct device *dev, struct device *master,
 	gpu->drm = drm;
 	gpu->fence_context = dma_fence_context_alloc(1);
 	idr_init(&gpu->fence_idr);
-	spin_lock_init(&gpu->fence_spinlock);
 
 	INIT_WORK(&gpu->sync_point_work, sync_point_worker);
 	init_waitqueue_head(&gpu->fence_event);
diff --git a/drivers/gpu/drm/etnaviv/etnaviv_gpu.h b/drivers/gpu/drm/etnaviv/etnaviv_gpu.h
index 74758f21e5d3..5fa58c79844c 100644
--- a/drivers/gpu/drm/etnaviv/etnaviv_gpu.h
+++ b/drivers/gpu/drm/etnaviv/etnaviv_gpu.h
@@ -124,7 +124,6 @@ struct etnaviv_gpu {
 	u32 completed_fence;
 	wait_queue_head_t fence_event;
 	u64 fence_context;
-	spinlock_t fence_spinlock;
 
 	/* worker for handling 'sync' points: */
 	struct work_struct sync_point_work;
