From: Michael Grzeschik <m.grzeschik@pengutronix.de>
Date: Thu, 20 Sep 2018 09:08:03 +0200
Subject: [PATCH] dsa: add self_test ethtool function handling

Signed-off-by: Michael Grzeschik <m.grzeschik@pengutronix.de>
---
 include/net/dsa.h |  2 ++
 net/dsa/slave.c   | 22 ++++++++++++++++++++--
 2 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/include/net/dsa.h b/include/net/dsa.h
index 631e75f03199..a91efb3a7be8 100644
--- a/include/net/dsa.h
+++ b/include/net/dsa.h
@@ -406,6 +406,8 @@ struct dsa_switch_ops {
 	void	(*get_ethtool_phy_stats)(struct dsa_switch *ds,
 					 int port, uint64_t *data);
 
+	void	(*self_test)(struct dsa_switch *ds, int port,
+			     struct ethtool_test *test, uint64_t *data);
 	/*
 	 * ethtool Wake-on-LAN
 	 */
diff --git a/net/dsa/slave.c b/net/dsa/slave.c
index 8157be7e162d..850f1a0fd26a 100644
--- a/net/dsa/slave.c
+++ b/net/dsa/slave.c
@@ -599,6 +599,17 @@ static void dsa_slave_get_strings(struct net_device *dev,
 	}
 }
 
+static void dsa_slave_self_test(struct net_device *dev,
+				struct ethtool_test *test,
+				uint64_t *data)
+{
+	struct dsa_port *dp = dsa_slave_to_port(dev);
+	struct dsa_switch *ds = dp->ds;
+
+	if (ds->ops->self_test)
+		ds->ops->self_test(ds, dp->index, test, data);
+}
+
 static void dsa_slave_get_ethtool_stats(struct net_device *dev,
 					struct ethtool_stats *stats,
 					uint64_t *data)
@@ -634,10 +645,9 @@ static int dsa_slave_get_sset_count(struct net_device *dev, int sset)
 {
 	struct dsa_port *dp = dsa_slave_to_port(dev);
 	struct dsa_switch *ds = dp->ds;
+	int count;
 
 	if (sset == ETH_SS_STATS) {
-		int count;
-
 		count = 4;
 		if (ds->ops->get_sset_count)
 			count += ds->ops->get_sset_count(ds, dp->index, sset);
@@ -645,6 +655,13 @@ static int dsa_slave_get_sset_count(struct net_device *dev, int sset)
 		return count;
 	}
 
+	if (sset == ETH_SS_TEST) {
+		if (ds->ops->get_sset_count)
+			count = ds->ops->get_sset_count(ds, dp->index, sset);
+
+		return count;
+	}
+
 	return -EOPNOTSUPP;
 }
 
@@ -1091,6 +1108,7 @@ static const struct ethtool_ops dsa_slave_ethtool_ops = {
 	.get_strings		= dsa_slave_get_strings,
 	.get_ethtool_stats	= dsa_slave_get_ethtool_stats,
 	.get_sset_count		= dsa_slave_get_sset_count,
+	.self_test		= dsa_slave_self_test,
 	.set_wol		= dsa_slave_set_wol,
 	.get_wol		= dsa_slave_get_wol,
 	.set_eee		= dsa_slave_set_eee,
