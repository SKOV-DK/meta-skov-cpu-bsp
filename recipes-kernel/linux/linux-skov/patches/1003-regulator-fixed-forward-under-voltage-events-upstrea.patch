From: Oleksij Rempel <o.rempel@pengutronix.de>
Date: Thu, 5 Oct 2023 12:48:25 +0200
Subject: [PATCH] regulator: fixed: forward under-voltage events upstream
 (downstream?)

Add handler for under-voltage forwarding

Signed-off-by: Oleksij Rempel <o.rempel@pengutronix.de>
---
 drivers/regulator/fixed.c | 48 +++++++++++++++++++++++++++++++++++++++++++++++
 1 file changed, 48 insertions(+)

diff --git a/drivers/regulator/fixed.c b/drivers/regulator/fixed.c
index e10c27c3ab80..8e008bd03360 100644
--- a/drivers/regulator/fixed.c
+++ b/drivers/regulator/fixed.c
@@ -33,6 +33,7 @@
 struct fixed_voltage_data {
 	struct regulator_desc desc;
 	struct regulator_dev *dev;
+	struct notifier_block nb;
 
 	struct clk *enable_clock;
 	unsigned int enable_counter;
@@ -105,6 +106,46 @@ static int reg_is_enabled(struct regulator_dev *rdev)
 	return priv->enable_counter > 0;
 }
 
+static int reg_fixed_regulator_notifier(struct notifier_block *nb,
+				      unsigned long event, void *data)
+{
+	struct fixed_voltage_data *priv = container_of(nb, struct fixed_voltage_data, nb);
+	struct regulator_dev *rdev = priv->dev;
+	int ret;
+
+	if (event != REGULATOR_EVENT_UNDER_VOLTAGE_WARN &&
+	    event != REGULATOR_EVENT_UNDER_VOLTAGE)
+		return NOTIFY_OK;
+
+	ret = regulator_notifier_call_chain(rdev, event,
+					    NULL);
+	if (ret == NOTIFY_BAD)
+		dev_err(rdev_get_dev(rdev),
+			"Failed to notify under voltage event\n");
+
+	return NOTIFY_OK;
+}
+
+static int reg_fixed_register_regulator_notifier(struct fixed_voltage_data *priv)
+{
+	struct regulator_dev *rdev = priv->dev;
+	int ret;
+
+	if (!rdev->supply) {
+		dev_err(&rdev->dev, "no supply\n");
+		return 0;
+	}
+
+	priv->nb.notifier_call = reg_fixed_regulator_notifier;
+	ret = devm_regulator_register_notifier(rdev->supply, &priv->nb);
+	if (ret) {
+		dev_err(&rdev->dev, "failed to register regulator notifier\n");
+		return ret;
+	}
+
+	return 0;
+}
+
 static irqreturn_t under_voltage_irq_handler(int irq, void *data)
 {
 	struct fixed_voltage_data *priv = data;
@@ -334,6 +375,13 @@ static int reg_fixed_voltage_probe(struct platform_device *pdev)
 		return ret;
 	}
 
+	ret = reg_fixed_register_regulator_notifier(drvdata);
+	if (ret) {
+		dev_err(&pdev->dev, "Failed to register notifier: %pe. TODO: clean up things\n",
+			ERR_PTR(ret));
+		return ret;
+	}
+
 	return 0;
 }
 
