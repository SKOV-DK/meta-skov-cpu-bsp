From: Juergen Borleis <jbe@pengutronix.de>
Date: Tue, 24 Nov 2015 11:09:42 +0100
Subject: [PATCH] DTS: fully describe the SD card's power supply

Signed-off-by: Juergen Borleis <jbe@pengutronix.de>
---
 arch/arm/boot/dts/imx6qdl-cpu.dtsi | 18 ++++++++++++++----
 1 file changed, 14 insertions(+), 4 deletions(-)

diff --git a/arch/arm/boot/dts/imx6qdl-cpu.dtsi b/arch/arm/boot/dts/imx6qdl-cpu.dtsi
index d1b243575ac3..1623fa5e6202 100644
--- a/arch/arm/boot/dts/imx6qdl-cpu.dtsi
+++ b/arch/arm/boot/dts/imx6qdl-cpu.dtsi
@@ -132,12 +132,16 @@
 
 		/* MMC power supply */
 		vcc_mmc: sdcard_power_supply {
+			pinctrl-names = "default";
+			pinctrl-0 = <&pinctrl_vcc_mmc>;
 			compatible = "regulator-fixed";
 			vin-supply = <&reg_3p3v>;
-			regulator-name = "SDHI3 Vcc";
+			regulator-name = "mmc_vcc_supply";
 			regulator-min-microvolt = <3300000>;
 			regulator-max-microvolt = <3300000>;
-			regulator-always-on;
+			gpio = <&gpio7 8 GPIO_ACTIVE_HIGH>;
+			enable-active-high;
+			startup-delay-us = <100>;
 		};
 	};
 
@@ -292,8 +296,6 @@
 				MX6QDL_PAD_SD3_DAT4__GPIO7_IO01		0x1f0b0		/* USDHC3 WP */
 				MX6QDL_PAD_EIM_D31__GPIO3_IO31		0x13000 	/* CAN RS */
 				MX6QDL_PAD_GPIO_18__SD3_VSELECT 	0x17059		/* SD3 VSelect */
-//				MX6QDL_PAD_SD3_RST__SD3_RESET		0x17059		/* SD3 Reset, always set to high under UBOOT */
-				MX6QDL_PAD_SD3_RST__GPIO7_IO08		0x80000000	/* SD3 Reset, always set to high under UBOOT */
 				MX6QDL_PAD_ENET_RX_ER__GPIO1_IO24       0x13000		/* Enet */
 				MX6QDL_PAD_SD4_DAT0__GPIO2_IO08		0x1b0b0		/* VC0 */
 				MX6QDL_PAD_SD4_DAT1__GPIO2_IO09         0x1b0b0		/* VC1 */
@@ -306,6 +308,12 @@
 			>;
 		};
 
+		pinctrl_vcc_mmc: vcc_mmc_grp {
+			fsl,pins = <
+				MX6QDL_PAD_SD3_RST__GPIO7_IO08		0x1b0b0		/* MMC Power Supply Switch */
+			>;
+		};
+
 		pinctrl_ecspi1_1: ecspi1grp-1 {
 			fsl,pins = <
 				MX6QDL_PAD_EIM_D17__ECSPI1_MISO 	0x100b1
@@ -517,6 +525,8 @@
 	wp-gpios = <&gpio7 1 0>;
 	cd-gpios = <&gpio7 0 0>;
 	status = "okay";
+	cap-power-off-card;
+	full-pwr-cycle;
 	vmmc-supply = <&vcc_mmc>;
 	fsl,delay-line;
 };
