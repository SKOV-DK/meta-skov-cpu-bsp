From: Philipp Zabel <p.zabel@pengutronix.de>
Date: Mon, 25 Mar 2019 17:43:40 +0100
Subject: [PATCH] media: coda: MPEG-2 end of stream handling

I assume flag 0x40000 is the end of stream signal of the MPEG-2 decoder
firmware. Once it is set, the firmware does not decode any further
frames, but it still continues to point out the remaining already
decoded frames for presentation. Once the last frame is reached, signal
it via the V4L2_BUF_FLAG_LAST mechanism.

Signed-off-by: Philipp Zabel <p.zabel@pengutronix.de>
---
 drivers/media/platform/chips-media/coda-bit.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/drivers/media/platform/chips-media/coda-bit.c b/drivers/media/platform/chips-media/coda-bit.c
index c3429ab1287b..1fa575722992 100644
--- a/drivers/media/platform/chips-media/coda-bit.c
+++ b/drivers/media/platform/chips-media/coda-bit.c
@@ -2411,6 +2411,7 @@ static void coda_finish_decode(struct coda_ctx *ctx)
 	int success;
 	u32 err_mb;
 	int err_vdoa = 0;
+	bool mpeg2_eos = false;
 	u32 val;
 
 	if (ctx->aborting)
@@ -2435,7 +2436,12 @@ static void coda_finish_decode(struct coda_ctx *ctx)
 	val = coda_read(dev, CODA_RET_DEC_PIC_SUCCESS);
 	if (val == 0x40001 && src_fourcc == V4L2_PIX_FMT_MPEG2) {
 		coda_dbg(1, ctx, "end of stream signal?\n");
-		/* TODO: stop if no frame finished */
+		/*
+		 * We expect that from this point on no new frames are decoded.
+		 * The firmware will continue to point out which already
+		 * decoded frames to present.
+		 */
+		mpeg2_eos = true;
 	} else if (val != 1) {
 		pr_err("DEC_PIC_SUCCESS = 0x%x\n", val);
 	}
@@ -2634,7 +2640,8 @@ static void coda_finish_decode(struct coda_ctx *ctx)
 			 */
 			coda_dbg(1, ctx, "last meta, marking as last frame\n");
 			dst_buf->flags |= V4L2_BUF_FLAG_LAST;
-		} else if (ctx->bit_stream_param & CODA_BIT_STREAM_END_FLAG &&
+		} else if ((ctx->bit_stream_param & CODA_BIT_STREAM_END_FLAG ||
+			    mpeg2_eos) &&
 			   display_idx == -1) {
 			/*
 			 * If there is no designated presentation frame anymore,
