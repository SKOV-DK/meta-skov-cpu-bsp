From: Michael Grzeschik <m.grzeschik@pengutronix.de>
Date: Thu, 20 Sep 2018 09:08:03 +0200
Subject: [PATCH] dsa: add self_test ethtool function handling

This patch adds the support for running the self_test
callback on dsa based interfaces.

Signed-off-by: Michael Grzeschik <m.grzeschik@pengutronix.de>
---
 include/net/dsa.h |  2 ++
 net/dsa/slave.c   | 20 ++++++++++++++++----
 2 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/include/net/dsa.h b/include/net/dsa.h
index 541fb514e31d..6090303eb06c 100644
--- a/include/net/dsa.h
+++ b/include/net/dsa.h
@@ -406,6 +406,8 @@ struct dsa_switch_ops {
 	void	(*get_ethtool_phy_stats)(struct dsa_switch *ds,
 					 int port, uint64_t *data);
 
+	void	(*self_test)(struct dsa_switch *ds, int port,
+			     struct ethtool_test *test, uint64_t *data);
 	/*
 	 * ethtool Wake-on-LAN
 	 */
diff --git a/net/dsa/slave.c b/net/dsa/slave.c
index 028e65f4b5ba..2ea1f3a6ddf3 100644
--- a/net/dsa/slave.c
+++ b/net/dsa/slave.c
@@ -659,6 +659,17 @@ static void dsa_slave_get_strings(struct net_device *dev,
 	}
 }
 
+static void dsa_slave_self_test(struct net_device *dev,
+				struct ethtool_test *test,
+				uint64_t *data)
+{
+	struct dsa_port *dp = dsa_slave_to_port(dev);
+	struct dsa_switch *ds = dp->ds;
+
+	if (ds->ops->self_test)
+		ds->ops->self_test(ds, dp->index, test, data);
+}
+
 static void dsa_slave_get_ethtool_stats(struct net_device *dev,
 					struct ethtool_stats *stats,
 					uint64_t *data)
@@ -694,11 +705,11 @@ static int dsa_slave_get_sset_count(struct net_device *dev, int sset)
 {
 	struct dsa_port *dp = dsa_slave_to_port(dev);
 	struct dsa_switch *ds = dp->ds;
+	int count = 4;
 
-	if (sset == ETH_SS_STATS) {
-		int count;
-
-		count = 4;
+	switch (sset) {
+	case ETH_SS_STATS:
+	case ETH_SS_TEST:
 		if (ds->ops->get_sset_count)
 			count += ds->ops->get_sset_count(ds, dp->index, sset);
 
@@ -1195,6 +1206,7 @@ static const struct ethtool_ops dsa_slave_ethtool_ops = {
 	.get_rxnfc		= dsa_slave_get_rxnfc,
 	.set_rxnfc		= dsa_slave_set_rxnfc,
 	.get_ts_info		= dsa_slave_get_ts_info,
+	.self_test		= dsa_slave_self_test,
 };
 
 /* legacy way, bypassing the bridge *****************************************/
