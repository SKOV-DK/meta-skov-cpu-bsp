From: Philipp Zabel <p.zabel@pengutronix.de>
Date: Thu, 25 Nov 2021 16:45:51 +0100
Subject: [PATCH] media: coda: add media controller

Add a media controller device to fix this v4l2-compliance test failure:

		fail: v4l2-test-codecs.cpp(35): node->function != MEDIA_ENT_F_PROC_VIDEO_ENCODER
	test VIDIOC_(TRY_)ENCODER_CMD: FAIL

Signed-off-by: Philipp Zabel <p.zabel@pengutronix.de>
---
 drivers/media/platform/coda/coda-common.c | 51 ++++++++++++++++++++++++++++++-
 drivers/media/platform/coda/coda.h        |  3 ++
 2 files changed, 53 insertions(+), 1 deletion(-)

diff --git a/drivers/media/platform/coda/coda-common.c b/drivers/media/platform/coda/coda-common.c
index 66edaab5bfc4..09217a1b3e4e 100644
--- a/drivers/media/platform/coda/coda-common.c
+++ b/drivers/media/platform/coda/coda-common.c
@@ -3428,9 +3428,38 @@ static void coda_fw_callback(const struct firmware *fw, void *context)
 		}
 	}
 
+#ifdef CONFIG_MEDIA_CONTROLLER
+	dev->mdev.dev = dev->v4l2_dev.dev;
+	strscpy(dev->mdev.model, CODA_NAME, sizeof(dev->mdev.model));
+	strscpy(dev->mdev.bus_info, "platform:" CODA_NAME, sizeof(dev->mdev.bus_info));
+	media_device_init(&dev->mdev);
+	dev->v4l2_dev.mdev = &dev->mdev;
+
+	for (i = 0; i < dev->devtype->num_vdevs; i++) {
+		int function = (dev->devtype->vdevs[i]->type == CODA_INST_ENCODER) ?
+			       MEDIA_ENT_F_PROC_VIDEO_ENCODER :
+			       MEDIA_ENT_F_PROC_VIDEO_DECODER;
+
+		ret = v4l2_m2m_register_media_function(&dev->m2m_func[i],
+						       &dev->vfd[i], function);
+		if (ret) {
+			v4l2_err(&dev->v4l2_dev,
+				 "Failed to register %s media function: %d\n",
+				 dev->devtype->vdevs[i]->name, ret);
+			goto rel_func;
+		}
+	}
+
+	ret = media_device_register(&dev->mdev);
+	if (ret) {
+		v4l2_err(&dev->v4l2_dev, "Failed to register media device\n");
+		goto rel_func;
+	}
+#endif
+
 	dev->bit_stats = v4l2_register_stats("coda-bit");
 	if (IS_ERR(dev->bit_stats))
-		goto rel_vfd;
+		goto rel_mdev;
 
 	if (dev->devtype->product == CODA_960) {
 		dev->jpeg_stats = v4l2_register_stats("coda-jpeg");
@@ -3443,6 +3472,14 @@ static void coda_fw_callback(const struct firmware *fw, void *context)
 
 unreg_bit:
 	v4l2_unregister_stats(dev->bit_stats);
+#ifdef CONFIG_MEDIA_CONTROLLER
+rel_mdev:
+	media_device_unregister(&dev->mdev);
+rel_func:
+	while (--i >= 0)
+		v4l2_m2m_unregister_media_function(&dev->m2m_func[i]);
+	media_device_cleanup(&dev->mdev);
+#endif
 rel_vfd:
 	while (--i >= 0)
 		video_unregister_device(&dev->vfd[i]);
@@ -3711,6 +3748,18 @@ static int coda_remove(struct platform_device *pdev)
 	if (dev->devtype->product == CODA_960)
 		v4l2_unregister_stats(dev->jpeg_stats);
 	v4l2_unregister_stats(dev->bit_stats);
+#ifdef CONFIG_MEDIA_CONTROLLER
+	if (media_devnode_is_registered(dev->mdev.devnode)) {
+		media_device_unregister(&dev->mdev);
+		for (i = 0; i < ARRAY_SIZE(dev->m2m_func); i++) {
+			if (!dev->m2m_func[i].source)
+				continue;
+
+			v4l2_m2m_unregister_media_function(&dev->m2m_func[i]);
+		}
+		media_device_cleanup(&dev->mdev);
+	}
+#endif
 	for (i = 0; i < ARRAY_SIZE(dev->vfd); i++) {
 		if (video_get_drvdata(&dev->vfd[i]))
 			video_unregister_device(&dev->vfd[i]);
diff --git a/drivers/media/platform/coda/coda.h b/drivers/media/platform/coda/coda.h
index ead14bdb5d03..d0e0ec9496fc 100644
--- a/drivers/media/platform/coda/coda.h
+++ b/drivers/media/platform/coda/coda.h
@@ -23,6 +23,7 @@
 #include <media/v4l2-ctrls.h>
 #include <media/v4l2-device.h>
 #include <media/v4l2-fh.h>
+#include <media/v4l2-mem2mem.h>
 #include <media/videobuf2-v4l2.h>
 
 #include "coda_regs.h"
@@ -88,7 +89,9 @@ struct coda_aux_buf {
 
 struct coda_dev {
 	struct v4l2_device	v4l2_dev;
+	struct media_device	mdev;
 	struct video_device	vfd[6];
+	struct v4l2_m2m_func	m2m_func[6];
 	struct device		*dev;
 	const struct coda_devtype *devtype;
 	int			firmware;
